name: remove-staging-after-pull-request

on:
  pull_request:
    types: [closed]

jobs:
  delete:
    runs-on: ubuntu-20.04

    steps:

      - uses: actions/checkout@v2

      - name: Set image tag
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c 1-7)
          echo "ghcr.io/internetee/auction_center:RC_$SHORT_SHA" > TAG
          echo "ghcr.io/internetee/auction_center:STATIC_RC_$SHORT_SHA" > STATIC_TAG
          echo "RC_$SHORT_SHA" > SHORT_TAG
          cat TAG

      - name: Set vpn config
        env:
          OVPN: ${{ secrets.OVPN }}
          VPN_PWD: ${{ secrets.VPN_PWD }}
          P12: ${{ secrets.P12 }}
          K_CONFIG: ${{ secrets.KUBE_CONFIG }}
          SSH_KEY: ${{ secrets.EISBOT_SSH_KEY }}
        run: |
          echo $VPN_PWD | base64 -di > client.pwd
          chmod 0600 client.pwd
          echo $OVPN | base64 -di >  config.ovpn
          echo $P12 | base64 -di > cert.p12
          mkdir -p ~/.ssh
          echo $SSH_KEY | base64 -di > ~/.ssh/key
          chmod 0600 ~/.ssh/key
          echo $K_CONFIG | base64 -di > kubeconfig
          chmod 0600 kubeconfig
      - name: Install Open VPN
        run: sudo apt-get install openvpn

      - name: Delete k8s 
        run: |
          sudo openvpn --config config.ovpn --askpass client.pwd --auth-nocache --daemon&
          sleep 15
          ping -c 2 192.168.99.12
          eval `ssh-agent`
          touch ~/.ssh/known_hosts   
          ssh-add ~/.ssh/key
          ssh-keyscan 192.168.99.12 > ~/.ssh/known_hosts
          scp SHORT_TAG runner@192.168.99.12:/home/runner/TAG
          scp kubeconfig runner@192.168.99.12:/home/runner/kubeconfig
          ssh -T runner@192.168.99.12 << 'EOL'
          bash
          export KUBECONFIG=./kubeconfig
          helm delete auction-st --namespace=auction-staging
          rm TAG
          rm kubeconfig
          EOL