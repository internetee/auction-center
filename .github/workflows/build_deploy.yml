name: build and deploy test environment on pr

on:
  pull_request:
    branches:
    - main

  push:
    branches:
    - build_test_deploy

jobs:
  
  build_and_test:
    runs-on: ubuntu-20.04

    steps:

      - uses: actions/checkout@v2

      - name: Set image tag
        run: |
          SHORT_SHA=$(git describe --always)
          echo "ghcr.io/internetee/auction_center:RC_$SHORT_SHA" > TAG

      - name: Set config files for build
        run: |
          cp config/database.yml.sample config/database.yml
          ls -l config/

      - name: Build image
        run: |
          docker build -t $(cat TAG) -f Dockerfile.generic .
          docker images

      # - name: Push to GitHub Packages
      #   uses: docker/build-push-action@v1
      #   with:
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GHCR_PAT }}
      #     registry: docker.pkg.github.com
      #     repository: internetee/auction_center
      #     tags: 
      #     tag_with_ref: true
      - name: Push Docker image to gh container registry
        env:
          PASSWORD: ${{ secrets.GHCR }}
        run: |
          echo $PASSWORD | docker login ghcr.io -u eisbot --password-stdin
          docker push $(cat TAG)
